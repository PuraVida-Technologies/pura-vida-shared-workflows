name: Build and Push to GCR

on:
  workflow_call:
    inputs:
      APP_NAME:
        required: true
        type: string
        description: "Image name (lowercase, dashes). e.g. 'stablesats'"
      IMAGE_TAG:
        required: true
        type: string
        description: "Tag to apply (semver, SHA, etc.). e.g. '1.2.3'"
      GKE_PROJECT:
        required: true
        type: string
        description: "GCP project ID hosting the registry. e.g. 'pvbtc-production'"
      DOCKERFILE_PATH:
        required: false
        type: string
        description: "Path to Dockerfile relative to WORKING_DIRECTORY"
        default: "Dockerfile"
      IMAGE_REPOSITORY:
        required: false
        type: string
        description: "Artifact Registry repo name"
        default: "us.gcr.io"
      IMAGE_REPOSITORY_REGION:
        required: false
        type: string
        description: "Artifact Registry region"
        default: "us"
      WORKING_DIRECTORY:
        required: false
        type: string
        description: "Docker build context directory"
        default: "."
      BUILD_ARGS:
        required: false
        type: string
        description: "Extra --build-arg pairs (KEY=VALUE, newline-delimited)"
        default: ""
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN:
        required: true
    outputs:
      image_tag:
        description: "The tag that was pushed"
        value: ${{ jobs.build_and_push.outputs.image_tag }}
      image_uri:
        description: "Full image URI"
        value: ${{ jobs.build_and_push.outputs.image_uri }}

jobs:
  build_and_push:
    name: Build & Push
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ inputs.IMAGE_TAG }}
      image_uri: ${{ steps.push.outputs.image_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load GCP credentials from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GCP_SA_KEY: op://infra-production-github/gcr-credentials/credential

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ inputs.IMAGE_REPOSITORY_REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
        run: |
          BUILD_ARGS_FLAGS=""
          if [ -n "${{ inputs.BUILD_ARGS }}" ]; then
            while IFS= read -r arg; do
              [ -n "$arg" ] && BUILD_ARGS_FLAGS="$BUILD_ARGS_FLAGS --build-arg $arg"
            done <<< "${{ inputs.BUILD_ARGS }}"
          fi

          docker build \
            --tag "${{ inputs.APP_NAME }}:${{ inputs.IMAGE_TAG }}" \
            --file "${{ inputs.DOCKERFILE_PATH }}" \
            $BUILD_ARGS_FLAGS \
            .

      - name: Push Docker image
        id: push
        run: |
          IMAGE_URI="${{ inputs.IMAGE_REPOSITORY_REGION }}-docker.pkg.dev/${{ inputs.GKE_PROJECT }}/${{ inputs.IMAGE_REPOSITORY }}/${{ inputs.APP_NAME }}:${{ inputs.IMAGE_TAG }}"
          docker tag "${{ inputs.APP_NAME }}:${{ inputs.IMAGE_TAG }}" "$IMAGE_URI"
          docker push "$IMAGE_URI"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"
